---
title: 象棋残局机器人四：策略
date: 2019-06-04 14:47:59
tags:
  - AlphaZero
---
关于下棋策略的方案，尝试使用了象棋引擎binghewusi和cyclone，最终选择开源项目cczero。



## 象棋引擎
* 中国象棋程序《象棋旋风》 </br>http://www.xqbase.com/league/xqcyclone.htm
* 中国象棋程序《兵河五四》 </br>http://www.xqbase.com/league/bhws.htm


### 中国象棋通用引擎协议
不管是Windows还是UNIX平台，能被界面调用的引擎都必须是编译过的可执行文件，它跟界面之间通过“标准输入”和“标准输出”(即C/C++语言中的stdin和stdout)通道来通讯。如果引擎从Windows平台移植到UNIX平台，那么需要重新编译源代码(管道操作的程序也需要作适当修改)，或使用跨平台接口。

* 中国象棋电脑应用规范(五)：中国象棋通用引擎协议</br>http://www.xqbase.com/protocol/cchess_ucci.htm

FEN格式串最初的棋局表示:
``` bash
rnbakabnr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/1C5C1/9/RNBAKABNR w - - 0 1
```
小写表示黑方，大写表示红方  
* 中国象棋电脑应用规范(三)：FEN文件格式 </br>http://www.xqbase.com/protocol/cchess_fen.htm  

调用象棋引擎，输入FEN格式串表的当前局面，获得当前局面策略，输出的策略是一个ICCS坐标格式的四位字符串
``` bash
import subprocess
import time
class Strategy:
    exepath = r".\strategy.exe"

    def __init__(self):
        self.p = subprocess.Popen(self.exepath, stdin=subprocess.PIPE,stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        ret = self.p.stdout.readline()

    def get_move(self, position = "rCbakabnr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/4C2C1/9/RNBAKABNR", 
                 player = "b", times = 1000, depth = 8, show_thinking = 1):   
        
        com = "position fen " + position + " " + player + " - - 0 1\r\n"
        self.p.stdin.write(com.encode('GBK'))
        # com = 'go depth ' + str(depth) + ' time 20000\r\n'
        com = 'go depth ' + str(depth) + '\r\n'
        self.p.stdin.write(com.encode('GBK'))
        self.p.stdin.flush()

        while True:
            ret = self.p.stdout.readline()
            if show_thinking:
                print(ret)
            if ret.decode()[:8] == 'bestmove':
                ans = ret.decode()[9:13]
                break
        # print("ans", ans)
        return ans

if __name__ == '__main__':
    ai = Strategy()
    situation = "rnbakabnr/9/1c5c1/p1p1p1p1p/9/9/P1P1P1P1P/2C4C1/9/RNBAKABNR"
    move = ai.get_move(position=situation, show_thinking = True)
    print(move)

```
棋盘标记
<div align=center>
<img src='象棋残局机器人四：策略\001.png' width=300 height=300>
</div>




## 开源项目cczero

众所周知，Deep Mind公司先后推出了Alpha Go, AlphaGo Zero 和 AlphaZero 三个棋类算法：AlphaGo吊打李世石、柯洁；AlphaGo Zero不用人类知识从零学起吊打AlphaGo；AlphaZero又分别在围棋、国际象棋和将棋领域取得了最高水平。cczero项目移植了AlphaZero算法。  
DeepMind用了5000个TPU才能在很短的时间内训练完成，cczero也需要巨大的计算资源才能使其征服中国象棋打败当今最强象棋程序，其开放跑谱教程，鼓励参与者贡献CPU/GPU时间，使这个项目变得越来越强。    
cczero项目为开源项目，引擎和权重永久免费，项目交流群为706396552。

* 中国象棋Zero</br> https://cczero.org/
* NeymarL/ChineseChess-AlphaZero: Implement AlphaZero/AlphaGo Zero methods on Chinese chess. </br>https://github.com/NeymarL/ChineseChess-AlphaZero
* 下载cczero最新权重 </br>https://cczero.org/api/models


调用cczero主要代码
``` bash
play = PlayWithHuman(config)
# play.start(human_first)
play.env.reset(init_state="r8/3k5/9/9/9/9/9/9/4A4/3AK4")
play.load_model()
play.pipe = play.model.get_pipes()
play.ai = CChessPlayer(play.config, search_tree=defaultdict(VisitState), pipes=play.pipe,
                        enable_resign=False, debugging=False)
human_first = not args.ai_move_first
play.human_move_first = human_first
move = ai.get_move(position=situation, show_thinking = True)
```


## 参考资料
* AlphaZero实践——中国象棋（附论文翻译） - 知乎</br> https://zhuanlan.zhihu.com/p/34433581

